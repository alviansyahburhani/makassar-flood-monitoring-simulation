<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pusat Kendali Banjir</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Teko:wght@500;700&family=Roboto+Condensed:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-dark: #1a222e; --card-bg: #242f3e; --text-light: #e1e1e1;
            --text-muted: #8c9bb3; --border-color: rgba(140, 155, 179, 0.2);
            --color-safe: #2ecc71; --color-alert: #f1c40f; --color-danger: #e74c3c;
        }
        html, body {
            height: 100%; margin: 0; padding: 0; overflow: hidden;
            font-family: 'Roboto Condensed', sans-serif; 
            background-color: var(--bg-dark); color: var(--text-light);
        }
        .main-container { height: 100vh; }
        #map { height: 100%; width: 100%; background-color: #0e141b; }
        .sidebar { background-color: var(--bg-dark); padding: 1.5rem; overflow-y: auto; height: 100vh; }
        .main-title { font-family: 'Teko', sans-serif; font-size: 2.5rem; letter-spacing: 2px; }
        
        .master-alert-card {
            border-radius: 1rem; padding: 1rem; text-align: center;
            border: 2px solid var(--border-color);
            transition: background-color 0.5s ease, border-color 0.5s ease;
            margin-bottom: 1.5rem;
        }
        .master-alert-card .label { text-transform: uppercase; font-size: 0.9rem; color: var(--text-muted); }
        .master-alert-card .status { font-family: 'Teko', sans-serif; font-size: 3rem; line-height: 1; }

        .sensor-card {
            background-color: var(--card-bg); border-left: 5px solid var(--border-color);
            border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem;
            transition: all 0.3s ease; cursor: pointer;
        }
        .sensor-card:hover, .sensor-card.active {
            transform: translateX(5px); background-color: #2c3a4d;
        }
        .sensor-card .location { font-weight: 700; font-size: 1.1rem; }
        .sensor-card .status { font-family: 'Teko', sans-serif; font-size: 2rem; line-height: 1; }
        .sensor-card .details { font-size: 0.9rem; color: var(--text-muted); }
        .sparkline-container { height: 40px; margin-top: 0.5rem; }
        
        #details-panel .card { background-color: var(--card-bg); border-radius: 0.5rem; }
        .table-dark { --bs-table-bg: var(--card-bg); --bs-table-border-color: var(--border-color); }

        .leaflet-popup-content-wrapper, .leaflet-popup-tip { background-color: var(--card-bg); color: var(--text-light); }
        .leaflet-popup-content { margin: 1rem; }
        .leaflet-control-attribution { display: none; }
    </style>
</head>
<body>
    <div class="container-fluid main-container p-0">
        <div class="row g-0 h-100">
            <div class="col-lg-8 h-100">
                <div id="map"></div>
            </div>
            <div class="col-lg-4 h-100">
                <div class="sidebar">
                    <header class="text-center mb-4">
                        <h1 class="main-title">PUSAT KENDALI BANJIR</h1>
                        <p class="text-muted">Makassar</p>
                    </header>
                    
                    <div id="master-alert" class="master-alert-card">
                        <div class="label">Status Sistem</div>
                        <div class="status">--</div>
                    </div>

                    <div id="sensor-list" class="mt-3">
                        <p class="text-center text-muted">Menunggu data dari sensor...</p>
                    </div>

                    <div id="details-panel" class="mt-3" style="display: none;">
                        <h5 class="mb-3" id="details-title">Detail Sensor</h5>
                        <div class="card p-3">
                            <canvas id="sensorChart" height="150"></canvas>
                        </div>
                        <div class="card p-3 mt-3">
                            <h6>5 Data Terakhir</h6>
                            <table class="table table-dark table-sm table-striped">
                                <thead>
                                    <tr><th>Waktu</th><th>Ketinggian</th><th>Status</th></tr>
                                </thead>
                                <tbody id="data-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const socket = io();
            const sensorListEl = document.getElementById('sensor-list');
            const masterAlertEl = document.getElementById('master-alert');
            const detailsPanel = document.getElementById('details-panel');
            const detailsTitle = document.getElementById('details-title');
            const dataTableBody = document.getElementById('data-table-body');
            
            const map = L.map('map').setView([-5.155, 119.480], 12);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(map);

            let sensors = {};
            let sensorChart;
            let activeSensorId = null;
            const statusColors = { "Aman": "#2ecc71", "Siaga": "#f1c40f", "AWAS": "#e74c3c" };
            const statusHierarchy = { "Aman": 1, "Siaga": 2, "AWAS": 3 };

            socket.on('update_sensor', function(data) {
                const sensorId = data.id_sensor;
                if (!sensors[sensorId]) initializeSensor(data);
                
                sensors[sensorId].data = data;
                sensors[sensorId].history.push({
                    time: new Date(data.timestamp * 1000).toLocaleTimeString('id-ID'),
                    level: data.ketinggian_air,
                    // PERBAIKAN: Menggunakan substring(2) untuk menghapus emoji dan spasi
                    status: data.status.substring(2) 
                });
                if (sensors[sensorId].history.length > 15) sensors[sensorId].history.shift();

                updateSensorDisplay(sensorId);
                updateMasterAlert();

                if (sensorId === activeSensorId) updateDetailsPanel();
            });

            function initializeSensor(data) {
                const sensorId = data.id_sensor;
                sensors[sensorId] = {};
                const colorKey = Object.keys(statusColors).find(key => data.status.includes(key)) || "Aman";
                const marker = L.circleMarker(data.coords, {
                    radius: 10, fillColor: statusColors[colorKey], color: "#fff",
                    weight: 2, opacity: 1, fillOpacity: 0.8
                }).addTo(map);
                sensors[sensorId].marker = marker;

                const cardHTML = `
                    <div class="sensor-card" id="card-${sensorId}">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="location"></div>
                            <div class="status"></div>
                        </div>
                        <div class="details mt-2"></div>
                        <div class="sparkline-container mt-2">
                            <canvas id="sparkline-${sensorId}" height="40"></canvas>
                        </div>
                    </div>`;
                sensorListEl.insertAdjacentHTML('beforeend', cardHTML);
                sensors[sensorId].card = document.getElementById(`card-${sensorId}`);
                sensors[sensorId].card.addEventListener('click', () => selectSensor(sensorId));
                
                sensors[sensorId].history = [];
                
                const sparklineCtx = document.getElementById(`sparkline-${sensorId}`).getContext('2d');
                sensors[sensorId].sparkline = new Chart(sparklineCtx, {
                    type: 'line',
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false }, tooltip: { enabled: false } },
                        scales: { x: { display: false }, y: { display: false } }
                    }
                });

                if(document.querySelector("#sensor-list p")) {
                    document.querySelector("#sensor-list p").remove();
                }
                if (!activeSensorId) selectSensor(sensorId);
            }

            function selectSensor(sensorId) {
                if (activeSensorId) sensors[activeSensorId].card.classList.remove('active');
                activeSensorId = sensorId;
                sensors[sensorId].card.classList.add('active');
                map.flyTo(sensors[sensorId].data.coords, 14);
                
                detailsPanel.style.display = 'block';
                if (!sensorChart) initializeChart();
                updateDetailsPanel();
            }

            function updateSensorDisplay(sensorId) {
                const { marker, card, data, sparkline, history } = sensors[sensorId];
                const colorKey = Object.keys(statusColors).find(key => data.status.includes(key)) || "Aman";
                const color = statusColors[colorKey];

                card.style.borderLeftColor = color;
                card.querySelector('.location').innerText = data.lokasi;
                // PERBAIKAN: Menggunakan substring(2) untuk menghapus emoji dan spasi
                card.querySelector('.status').innerText = data.status.substring(2);
                card.querySelector('.status').style.color = color;
                card.querySelector('.details').innerHTML = `Ketinggian: <strong>${data.ketinggian_air} cm</strong> | Arus: <strong>${data.kecepatan_arus} m/s</strong>`;
                
                marker.setStyle({ fillColor: color });
                marker.bindPopup(`<strong>${data.lokasi}</strong><br>Status: <span style="color:${color}; font-weight:bold;">${data.status.substring(2)}</span>`);

                // Update sparkline
                sparkline.data = {
                    labels: history.map(h => h.time),
                    datasets: [{
                        data: history.map(h => h.level),
                        borderColor: color,
                        borderWidth: 2,
                        pointRadius: 0
                    }]
                };
                sparkline.update();
            }

            function updateMasterAlert() {
                let highestStatus = "Aman";
                for (const id in sensors) {
                    const sensorStatusKey = Object.keys(statusColors).find(key => sensors[id].data.status.includes(key)) || "Aman";
                    if (statusHierarchy[sensorStatusKey] > statusHierarchy[highestStatus]) {
                        highestStatus = sensorStatusKey;
                    }
                }
                masterAlertEl.querySelector('.status').innerText = highestStatus;
                masterAlertEl.style.backgroundColor = statusColors[highestStatus];
                masterAlertEl.style.borderColor = statusColors[highestStatus];
            }
            
            function updateDetailsPanel() {
                if (!activeSensorId) return;
                const sensorData = sensors[activeSensorId];
                detailsTitle.innerText = `Detail - ${sensorData.data.lokasi}`;

                // Update tabel
                let tableHTML = '';
                [...sensorData.history].reverse().slice(0, 5).forEach(h => {
                    const statusColorKey = Object.keys(statusColors).find(key => h.status.includes(key)) || "Aman";
                    tableHTML += `<tr><td>${h.time}</td><td>${h.level} cm</td><td><span style="color:${statusColors[statusColorKey]}">${h.status}</span></td></tr>`;
                });
                dataTableBody.innerHTML = tableHTML;
                
                // Update grafik utama
                updateChart();
            }

            function initializeChart() {
                const ctx = document.getElementById('sensorChart').getContext('2d');
                sensorChart = new Chart(ctx, {
                    type: 'line',
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { ticks: { color: 'white', callback: (v) => v + ' cm' } },
                            x: { ticks: { color: 'white' } }
                        }
                    }
                });
            }

            function updateChart() {
                if (!sensorChart || !activeSensorId) return;
                const sensorData = sensors[activeSensorId];
                sensorChart.data = {
                    labels: sensorData.history.map(h => h.time),
                    datasets: [{
                        label: 'Ketinggian Air',
                        data: sensorData.history.map(h => h.level),
                        fill: true,
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        tension: 0.3
                    }]
                };
                sensorChart.update();
            }
        });
    </script>
</body>
</html>
